#
# $Id$
#
# :ts=8
#
# -*- mode: makefile; -*-

##############################################################################

.PHONY : all all-targets clean version cvs-tag

# You may have to change the following sets of macro definitions which will
# be used throughout the build makefile. These definitions cover the paths
# to look into for the operating system and networking header files, and
# the names and parameters passed to the program which actually do the
# compilation, library building and cleanup work.
#
# Note that for either set you still need the GNU make utility to build the
# library!

# These are for the cross compiler, with the operating system header files
# stored in "/V/include" and the network header files in a local directory
# called "netinclude".
SDK_INCLUDE := /V/include
NET_INCLUDE := netinclude
CC := ppc-amigaos-gcc
AR := ppc-amigaos-ar -q
RANLIB := ppc-amigaos-ranlib
COPY := cp -a
DELETE := rm -rf
MAKEDIR := mkdir -p
LOG_COMMAND := 2>&1 | tee -a compiler.log

# The following are for the native OS4 compiler; note that the
# LOG_COMMAND should not be enabled unless you have a shell
# installed which supports it.
#SDK_INCLUDE := /SDK/Include/include_h
#NET_INCLUDE := /SDK/Include/netinclude
#CC := distcc gcc
#AR := ar -q
#RANLIB := ranlib
#COPY := copy
#DELETE := delete all quiet force
#MAKEDIR := makedir all force
#LOG_COMMAND := *>< | tee >>compiler.log

##############################################################################

WARNINGS := \
	-Wall -W -Wpointer-arith -Wsign-compare -Wmissing-prototypes \
	-Wundef -Wbad-function-cast -Wmissing-declarations -Wunused -Wwrite-strings

#	-Wconversion -Wshadow

INCLUDES   := -Iinclude -I. -I$(SDK_INCLUDE)
 OPTIONS   := -DUSE_64_BIT_INTS -D__USE_INLINE__ -Wa,-mregnames -fno-common -std=gnu99
OPTIMIZE   := -DNDEBUG -O3

#DEBUG     := -ggdb
#MEMDEBUG  := -D__USE_MEM_TREES -D__MEM_DEBUG

CFLAGS     := $(WARNINGS) $(OPTIMIZE) $(DEBUG) $(MEMDEBUG) $(OPTIONS) $(INCLUDES)
AFLAGS     := -Wa,-mregnames

LARGEDATA  := -msdata=data
SOFTFLOAT  := -msdata=data -msoft-float
SMALLDATA  := -msdata=sysv -DSMALL_DATA
BASEREL    := -mbaserel -DBASEREL_DATA
THREADSAFE := -D__THREAD_SAFE

##############################################################################

# This is the first target: it depends on all the targets

all: all-targets

##############################################################################

# The LIBS variable is updated by each of the included library makefiles.

LIBS :=

include libc.gmk
include libunix.gmk
include libm.gmk
include libnet.gmk
include libdebug.gmk
include libamiga.gmk
include libprofile.gmk

all-targets: \
	lib/crt0.o \
	lib/small-data/crt0.o \
	lib/baserel/crt0.o \
	$(LIBS)

##############################################################################

# Delete all object files and libraries
clean:
	-$(DELETE) obj
	-$(DELETE) obj.threadsafe
	-$(DELETE) lib
	-$(DELETE) lib.threadsafe
	-$(DELETE) compiler.log

##############################################################################

# Update the version numbers bound to the individual libraries
version:
	$(COPY) c.lib_rev.rev amiga.lib_rev.rev
	$(COPY) c.lib_rev.rev debug.lib_rev.rev
	$(COPY) c.lib_rev.rev m.lib_rev.rev
	$(COPY) c.lib_rev.rev net.lib_rev.rev
	$(COPY) c.lib_rev.rev unix.lib_rev.rev
	$(COPY) c.lib_rev.rev profile.lib_rev.rev
	bumprev 1 amiga.lib
	bumprev 1 c.lib
	bumprev 1 debug.lib
	bumprev 1 m.lib
	bumprev 1 net.lib
	bumprev 1 unix.lib
	bumprev 1 profile.lib

##############################################################################

# Tag all files with a certain version number
cvs-tag:
	cvs -q tag V1_`cat c.lib_rev.rev`

##############################################################################

# General build rules for all object files and the individual libraries

lib/%.o : AFLAGS += $(LARGEDATA)
lib/%.o : %.S
	@$(ASSEMBLE)

lib/small-data/%.o : AFLAGS += $(SMALLDATA)
lib/small-data/%.o : %.S
	@$(ASSEMBLE)

lib/baserel/%.o : AFLAGS += $(BASEREL)
lib/baserel/%.o : %.S
	@$(ASSEMBLE)

##############################################################################

define COMPILE
$(MAKEDIR) $(@D)
echo "Compiling $< [$(@D)]"
$(CC) -o $@ -c $(CFLAGS) $< $(LOG_COMMAND)
endef

define ASSEMBLE
$(MAKEDIR) $(@D)
echo "Assembling $< [$(@D)]"
$(CC) -o $@ -c $(AFLAGS) $< $(LOG_COMMAND)
endef

define MAKELIB
$(MAKEDIR) $@
$(DELETE) $@
echo "Making $@"
$(AR) $@ $^ $(LOG_COMMAND)
$(RANLIB) $@ $(LOG_COMMAND)
endef
